---
title: "Blood Pressure Analysis in R: A Vignette"
author:
  - name: John Schwenck
    affiliation: Texas A\&M University
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Blood Pressure Analysis in R: A Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
abstract: "In an effort to better understand the factors that influence hypertension and cardiovascular disease, recent technology such as ambulatory blood pressure monitors (ABPM) have been employed in clinical practice to assess trends over an entire 24-hour period. However, despite these advancements, and until now, there has yet to be a comprehensive open-source R package that provides the necessary tools for analyzing such data. The `bp` package provides an extensive framework for researchers to analyze both ABPM and non-ABPM blood pressure data in R through a variety of statistical methods and metrics from the literature."
keywords: "blood pressure analysis, hypertension, cardiovascular disease"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(bp)
```


-------------

## Introduction
Despite the tremendous progress in the medical field, cardiovascular (CV) disease remains the leading cause of death worldwide. Hypertension, specifically, affects over 1.1 billion people annually according to the American Heart Association. This package serves to visualize and quantify various aspects of hypertension in a more digestible format using various metrics proposed in the literature. 

Blood pressure data can be analyzed at varying degrees of granularity depending on the reading frequency, presence of a sleep indicator, and whether or not the temporal structure is accounted for. These factors almost always depend on the type of device used, where ABPM monitors are predominantly used for the short term (within 24 hours) and home monitoring devices or office readings are used for measuring variability over the medium and long term (day-to-day, visit-to-visit, etc). Unlike continuous heart rate monitors or continuous glucose monitors, there are currently no large-scale continuous blood pressure monitors available for the middle to long term, posing a unique challenge for research.

###### Blood Pressure Monitors
Blood pressure monitoring devices work by measuring the pressure of the artery’s restricted blood flow; for digital devices, the vibrations are translated into electrical signals. Unlike home monitors that only take readings upon the subject's initiation, ambulatory blood pressure monitoring (ABPM) devices take automatic readings at pre-specified intervals over a 24-hour period or longer.

ABPM allows medical professionals to analyze blood pressure during sleep which has been shown to be a more accurate predictor of CV events than daytime blood pressure. ABPM also allows researchers to discern true hypertension from "whitecoat" hypertension in an office or laboratory setting. 

###### Blood Pressure Variability
Of primary concern to researchers is the ability to accurately quantify blood pressure variability. 

## The `bp` Package
The general workflow of the `bp` package consists of a data processing stage and an analysis stage. The processing stage formats the input data so that it adheres to the rest of the `bp` functions. The analysis stage uses the processed data to quantify various attributes of the relationships within the blood pressure data.

##### Data Processing with the `process_data` function
Before any analysis can be done, the user-supplied data set must be first processed into the proper format using `process_data` to adhere to package data structure requirements and naming conventions. This function ensures that user-supplied data columns aren't double counted or missed, since blood pressure data are often inconsistent and come from a wide variety of formats. While a tedious initial step, it will save time in the long-run as the resulting processed data will not require any future specification, which can then be directly plugged into the metric functions. It is worth noting that if the user-supplied data set already adheres to the column naming conventions and data types, then the `process_data` function will be unnecessary. However, it is good practice to still make use of this function as a sanity check to verify all available variables.

The basic workflow is to load in the user-supplied and un-processed raw data, process it with the `process_data` function and save to a new dataframe. Note that the capitalization does not matter when specifying the columns.
```{r}
## Load the sample hypnos_data
## In this scenario, the hypnos_data acts as the "user-supplied" data that is to be processed
data("hypnos_data")

## Assign the output of the process_data function to a new dataframe object
data1 <- process_data(hypnos_data,
                     sbp = 'syst',
                     dbp = 'diast',
                     bp_datetime = 'date.time',
                     id = 'id',
                     visit = 'visit',
                     hr = 'hr',
                     wake = 'wake',
                     pp = 'pp',
                     map = 'map',
                     rpp = 'rpp')
```
Notice how the column names of the original `hypnos_data` changed in the processed `data`. Notably, `SYST` became `SBP`, `DIAST` became `DBP`, and`DATE.TIME` became `DATE_TIME`.
```{r}
names(hypnos_data)
names(data1)
```

While the results seem to be trivial at first glance, let's see what happens when we use a much different data set with a completely different naming convention - the `bp_jhs` data set. Unlike `hypnos_data` which has all of the available columns needed in the `process_data` function with multiple subjects, `bp_jhs` is a single-subject data set without many of the multi-subject identifiers such as `ID`, `VISIT`, or `WAKE` (as it is non-ABPM data). Further, there is no `MAP` or `PP` column, but these (as we will see) can be automatically created. 
```{r warning=FALSE, message=TRUE}
## Load the sample bp_jhs data set
## As before, this is what will be referred to as the "user-supplied" data set
data("bp_jhs")

## Assign the output of the process_data function to a new dataframe object
data2 <- process_data(bp_jhs,
                     sbp = 'sys.mmhg.',
                     dbp = 'dias.mmhg.',
                     bp_datetime = 'datetime',
                     hr = 'PULSE.BPM.')
head(data2, 5)
```
After a quick inspection of the original `bp_jhs` data set and the newly processed `data` data set, it should be evident that there was a lot going on "under the hood" of the `process_data` function. As we can see from the column names, the awkward nuisance of typing `sys.mmhg.`, `dias.mmhg.`, `pulse.bpm.`, and `datetime` have now been replaced with the more concise `SBP`, `DBP`, `HR`, and `DATE_TIME` names, respectively. Additionally, `MAP`, `PP`, and `RPP` were all calculated as additional columns which previously did not exist in the data.
```{r}
names(bp_jhs)
names(data2)
```
**NOTE:** For consistency, `process_data` will coerce all column names to upper-case.

##### Blood Pressure Metrics
After the data has been processed, we can now utilize the built-in metrics from the literature to characterize the blood pressure variability. To start, the following metrics are what is currently offered through the `bp` package:

Function    | Metric Name                             | Source
----------- | --------------------------------------- | ----------
arv         | Average Real Variability                | [Mena et al](https://doi.org/10.1097/01.hjh.0000160205.81652.5a)
bp_mag      | Blood Pressure Magnitude                | [Munter et al](https://doi.org/10.1097/HJH.0b013e32834cf213 )
bp_range    | Blood Pressure Range                    | [Levitan et al](https://doi.org/10.1038/jhh.2013.19)
cv          | Coefficient of Variation                | [Munter et al](https://doi.org/10.1097/HJH.0b013e32834cf213 )
sv          | Successive Variation                    | [Munter et al](https://doi.org/10.1097/HJH.0b013e32834cf213 )
dip_calc    | Nocturnal Dipping \% and Classification | [Okhubo et al](https://doi.org/10.1016/s0895-7061(97)00274-4)

**Time-Dependent Dispersion Metrics**  

* `arv` - **Average Real Variability**
  + A measure of dispersion using the sum of absolute differences in successive observations
* `sv` - **Successive Variation**
  + A measure of dispersion using the sum of squared differences in successive observations
  
**Time-Independent Dispersion Metrics**  

* `bp_mag` - **Blood Pressure Magnitude** (peak and trough)
  + Peak measures the distance from the average value to the maximum value
  + Trough measures the distance from the minimum value to the average value
* `bp_range` - **Blood Pressure Range**
  + Range measures the distance from the minimum value to the maximum value
* `cv` - **Coefficient of Variation**
  + Coefficient of Variation is a ratio of the standard deviation / average

**Sleep-dependent Metrics**

* `dip_calc` - **Nocturnal Dipping \% and Classification**
  + this is test text


Let's say we are working with the `hypnos_data` and would like to compare the time-dependent nature of the `arv` with the `sv` for each subject. 
```{r}
head(arv(data1))
head(sv(data1))
```
Comparing vertically can be challenging, so with some help from `dplyr` we can obtain the following:
```{r}
head(dplyr::left_join(arv(data1), cv(data1)))
```
Note that this is possible thanks to the work we did in standardizing column names from the processing step.

Suppose instad we wanted to look at peaks and troughs of the single-subject data set `bp_jhs`. We would then call the `bp_mag` function on our data.
```{r}
head(bp_mag(data2))
```
Here, we notice something different. Because there weren't `ID`, `VISIT`, or `WAKE` columns, the `bp_mag` aggregated everything together. This is technically correct, but say we wanted to glean more information by breaking our data down by `DATE` instead; we would need to include the `inc_date = TRUE` optional argument to the function.
```{r}
tail(bp_mag(data2, inc_date = TRUE))
```
***Interpretation:*** While it may not seem obvious at first glance, the blood pressure magnitude (whether a peak or a trough) is calculated as $peak = max(BP) - mean(BP)$ and $trough = mean(BP) - min(BP)$ where BP could correspond to either SBP or DBP. If we manually inspect the data from `2019-07-31` we see that N = 2 measurements and within the `bp_jhs` data set we see the two measurements are 126 and 128 for SBP and 77, and 76 for DBP. $\bar{x}_{SBP} = \frac{(126+128)}{2} = 127$ and $\bar{x}_{DBP} = \frac{(78+76)}{2} = 76.5$ so the respective peak and trough values from our output make sense.
  
##### Visualization
So far, we have processed the original data, we have run a couple metrics to get a clearer picture of the variability, now let's visualize it.

Continuing with our previous example using the `bp_jhs` data set, let's suppose we wanted to explore how to peaks and troughs of systolic blood pressure changed over time
```{r fig1, fig.height = 4.5, fig.width = 7.5, fig.align = "center"}
viz_data <- bp_mag(data2, inc_date = TRUE)
plot(viz_data[which(viz_data$Peak_SBP > 0 & viz_data$N > 1),]$DATE, viz_data[which(viz_data$Peak_SBP > 0 & viz_data$N > 1),]$Peak_SBP, type = 'l', col = "red", xlab ="DATE", ylab = "Magnitude")
lines(viz_data[which(viz_data$Peak_SBP > 0 & viz_data$N > 1),]$DATE, viz_data[which(viz_data$Trough_SBP > 0 & viz_data$N > 1),]$Trough_SBP, col = "darkgreen")
legend("topright", legend = c("Peak", "Trough"), col = c("red","darkgreen"), lty =1)
```
From the above time series chart, notice that the values are absolute magnitudes for both peak and trough. So, when peak exceeds trough, as was evident during late-May and early-June, the interpretation is that blood pressure rose more on average than it fell. In other words, the **variability** of the blood pressure data is right-skewed more toward the high end. In contrast, in the very beginning the variability was more left-skewed favoring the low end of the spectrum since there were more troughs than peaks. We can verify this by looking at the very first day of measurements on `2020-04-16` as shown below:
```{r}
head(viz_data[which(viz_data$Peak_SBP > 0 & viz_data$N > 1),])
```


Suppose now that we turn our attention back to the `hypnos_data` example where we joined the `ARV` and `CV` metrics together. We would now like to visualize these for all of the subjects to see if we can discern any patterns. From the first scatterplot matrix we see that the between-subject values differ and from the second scatterplot matrix we see that there is a very stark contrast between `ARV` and `CV` during sleep vs awake.  
```{r fig2, fig.height = 4.5, fig.width = 6.5, fig.align = "center"}
viz_arv_cv <- dplyr::left_join(arv(data1), cv(data1))
pairs(viz_arv_cv[,4:(ncol(viz_arv_cv)-1)], upper.panel = NULL, col = factor(viz_arv_cv$ID))
pairs(data1[,6:11], upper.panel = NULL, col = factor(data1$WAKE))
```


## Future Directions

As our understanding of cardiovascular disease continues to grow, this package will remain ongoing project. As such, collaboration is highly encouraged. Corrections to existing metrics, extensions or new method proposals, and code optimization are all welcome. 

In the short term, the following new features are to be incorporated with the next release of the package: 

* Shiny App for visualization and PDF export
* Package website
* Additional metrics: morning BP surge, morning bp surge power, SDIM
* add an inc_time optional argument that breaks down groupings by time (similar to by day, but more useful for ABPM when time of day is of interest)

-------------
### References

1. Mancia, G., Di Rienzo, M., & Parati, G. (1993). Ambulatory blood pressure monitoring use in hypertension research and clinical practice. *Hypertension*, 21(4), 510-524.

2. Levitan, E., Kaciroti, N., Oparil, S. et al. Relationships between metrics of visit-to-visit variability of blood pressure. *J Hum Hypertens* 27, 589–593 (2013). doi: 10.1038/jhh.2013.19

3. Muntner, Paula,b; Joyce, Carac; Levitan, Emily B.a; Holt, Elizabethd; Shimbo, Daichie; Webber, Larry S.c; Oparil, Suzanneb; Re, Richardf; Krousel-Wood, Maried,g Reproducibility of visit-to-visit variability of blood pressure measured as part of routine clinical care, *Journal of Hypertension*: December 2011 - Volume 29 - Issue 12 - p 2332-2338
doi: 10.1097/HJH.0b013e32834cf213 

4. O’Brien E, Sheridan J, O’Malley K . Dippers and non-dippers. Lancet 1988; 2: 397.

5. Ohkubo T, Imai Y, Tsuji I, Nagai K, Watanabe N, Minami N, Kato J, Kikuchi N, Nishiyama A, Aihara A, Sekino M, Satoh H, Hisamichi S. Relation between nocturnal decline in blood pressure and mortality. The Ohasama Study. *Am J Hypertens*. 1997 Nov;10(11):1201-7. doi: 10.1016/s0895-7061(97)00274-4. PMID: 9397237.
